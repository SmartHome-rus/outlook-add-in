<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manifest Validator</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #0078d4;
            margin-bottom: 20px;
        }
        
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 5px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            background-color: #fafafa;
        }
        
        .upload-area.dragover {
            border-color: #0078d4;
            background-color: #e3f2fd;
        }
        
        input[type="file"] {
            margin: 10px 0;
        }
        
        .result {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
        }
        
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .checklist {
            margin: 20px 0;
        }
        
        .checklist li {
            margin: 10px 0;
            padding: 5px 0;
        }
        
        .check-pass::before {
            content: "✅ ";
        }
        
        .check-fail::before {
            content: "❌ ";
        }
        
        .check-warn::before {
            content: "⚠️ ";
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Office Add-in Manifest Validator</h1>
        
        <p>Upload your <code>manifest.xml</code> file to validate it for common issues:</p>
        
        <div class="upload-area" id="uploadArea">
            <p>Drag and drop your manifest.xml file here, or</p>
            <input type="file" id="fileInput" accept=".xml" />
        </div>
        
        <div id="results"></div>
        
        <h2>Common Issues Checked:</h2>
        <ul>
            <li>Valid XML structure</li>
            <li>Required namespaces present</li>
            <li>Proper VersionOverrides structure</li>
            <li>Required elements for event-based activation</li>
            <li>Valid URLs (HTTPS required)</li>
            <li>Proper GUID format for ID</li>
            <li>Required permissions present</li>
        </ul>
        
        <h2>Manual Checklist:</h2>
        <div class="checklist">
            <div class="check-list">
                <p><strong>Before uploading to Outlook:</strong></p>
                <ul>
                    <li>All resource URLs are accessible via HTTPS</li>
                    <li>GitHub Pages is enabled and serving files</li>
                    <li>Icons are properly sized (16x16, 32x32, 64x64, 80x80)</li>
                    <li>Dialog HTML loads correctly in browser</li>
                    <li>Commands HTML loads correctly in browser</li>
                    <li>No browser console errors when loading resources</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const results = document.getElementById('results');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                validateFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                validateFile(e.target.files[0]);
            }
        });

        function validateFile(file) {
            if (!file.name.toLowerCase().endsWith('.xml')) {
                showResult('error', 'Please select an XML file');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const xmlContent = e.target.result;
                validateManifest(xmlContent);
            };
            reader.readAsText(file);
        }

        function validateManifest(xmlContent) {
            const issues = [];
            const warnings = [];
            
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlContent, 'text/xml');
                
                // Check for XML parsing errors
                const parseError = xmlDoc.querySelector('parsererror');
                if (parseError) {
                    issues.push('XML is not well-formed: ' + parseError.textContent);
                    showResult('error', 'XML Parsing Error', issues);
                    return;
                }

                // Check root element
                const officeApp = xmlDoc.querySelector('OfficeApp');
                if (!officeApp) {
                    issues.push('Missing OfficeApp root element');
                }

                // Check required namespaces
                const requiredNamespaces = [
                    'http://schemas.microsoft.com/office/appforoffice/1.1',
                    'http://schemas.microsoft.com/office/officeappbasictypes/1.0'
                ];
                
                requiredNamespaces.forEach(ns => {
                    if (!xmlContent.includes(ns)) {
                        issues.push(`Missing required namespace: ${ns}`);
                    }
                });

                // Check required elements
                const requiredElements = ['Id', 'Version', 'ProviderName', 'DefaultLocale', 'DisplayName', 'Description'];
                requiredElements.forEach(element => {
                    if (!xmlDoc.querySelector(element)) {
                        issues.push(`Missing required element: ${element}`);
                    }
                });

                // Check ID format (should be GUID)
                const id = xmlDoc.querySelector('Id');
                if (id) {
                    const guidPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
                    if (!guidPattern.test(id.textContent.trim())) {
                        warnings.push('ID should be a valid GUID format');
                    }
                }

                // Check URLs are HTTPS
                const urlElements = xmlDoc.querySelectorAll('[DefaultValue*="http"]');
                urlElements.forEach(element => {
                    const url = element.getAttribute('DefaultValue');
                    if (url && !url.startsWith('https://')) {
                        issues.push(`Non-HTTPS URL found: ${url}`);
                    }
                });

                // Check for VersionOverrides
                const versionOverrides = xmlDoc.querySelector('VersionOverrides');
                if (!versionOverrides) {
                    warnings.push('No VersionOverrides found - may not support modern Outlook clients');
                }

                // Check for event-based activation
                const launchEvent = xmlDoc.querySelector('LaunchEvent[Type="OnMessageSend"]');
                if (!launchEvent) {
                    warnings.push('No OnMessageSend event found - event-based activation may not work');
                }

                // Check permissions
                const permissions = xmlDoc.querySelector('Permissions');
                if (!permissions || !permissions.textContent.includes('ReadWriteItem')) {
                    issues.push('ReadWriteItem permission required for email body access');
                }

                // Check Rule element
                const rule = xmlDoc.querySelector('Rule');
                if (!rule) {
                    issues.push('Missing Rule element required by schema');
                }

                // Show results
                if (issues.length === 0 && warnings.length === 0) {
                    showResult('success', 'Manifest validation passed!', ['All required elements present', 'Schema structure looks correct']);
                } else if (issues.length === 0) {
                    showResult('warning', 'Manifest validation passed with warnings', warnings);
                } else {
                    showResult('error', 'Manifest validation failed', issues, warnings);
                }

            } catch (error) {
                showResult('error', 'Validation error: ' + error.message);
            }
        }

        function showResult(type, title, items = [], warnings = []) {
            let html = `<div class="result ${type}"><h3>${title}</h3>`;
            
            if (items.length > 0) {
                html += '<ul>';
                items.forEach(item => {
                    html += `<li>${item}</li>`;
                });
                html += '</ul>';
            }
            
            if (warnings.length > 0) {
                html += '<h4>Warnings:</h4><ul>';
                warnings.forEach(warning => {
                    html += `<li>${warning}</li>`;
                });
                html += '</ul>';
            }
            
            html += '</div>';
            results.innerHTML = html;
        }
    </script>
</body>
</html>