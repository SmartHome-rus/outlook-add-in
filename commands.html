<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Sensitive Data Scanner - Commands</title>

    <!-- Office JavaScript API will be provided by the host environment -->
    <!-- No external script needed - Office.js is automatically available in add-in runtime -->
<script defer src="polyfill.js"></script><script defer src="commands.js"></script></head>

<body>
    <!-- This page hosts the event-based activation functions -->
    <div style="display: none;">
        <h1>Sensitive Data Scanner - Event Handler</h1>
        <p>This page hosts the event-based activation functions for the Sensitive Data Scanner add-in.</p>
        <p>The functions defined here will be called automatically when users attempt to send emails or calendar invitations.</p>
    </div>

    <!-- Service Worker Registration & Debugging -->
    <script>
        console.log('üöÄ Commands page loaded at:', new Date().toISOString());
        console.log('üåê Navigator online:', navigator.onLine);
        console.log('üìç Current URL:', window.location.href);

        // Register Service Worker for offline caching with SSL error handling
        if ('serviceWorker' in navigator) {
            console.log('üì± Service Worker supported');
            
            // First, try to register with current domain
            function registerServiceWorker() {
                // Use relative path for GitHub Pages
                const swPath = './sw.js';
                console.log('üìù Attempting to register SW at:', swPath);
                console.log('üìç From GitHub Pages:', window.location.origin);
                
                return navigator.serviceWorker.register(swPath, { 
                    scope: './',
                    updateViaCache: 'none'  // Force fresh fetch of SW
                })
                .then((registration) => {
                    console.log('‚úÖ Service Worker registered successfully');
                    console.log('üì¶ Scope:', registration.scope);
                    console.log('üì¶ State:', registration.active?.state);
                    console.log('üì¶ Installing state:', registration.installing?.state);
                    console.log('üì¶ Waiting state:', registration.waiting?.state);
                    
                    // Force activation if waiting
                    if (registration.waiting) {
                        console.log('üîÑ Activating waiting service worker');
                        registration.waiting.postMessage({type: 'SKIP_WAITING'});
                    }
                    
                    // Listen for state changes
                    if (registration.installing) {
                        registration.installing.addEventListener('statechange', (e) => {
                            console.log('üîÑ SW state changed to:', e.target.state);
                        });
                    }
                    
                    return registration;
                })
                .catch((error) => {
                    console.error('‚ùå Service Worker registration failed:', error);
                    console.error('‚ùå Error type:', error.constructor.name);
                    console.error('‚ùå Error message:', error.message);
                    
                    // If SSL error, provide guidance
                    if (error.message.includes('SSL') || error.message.includes('certificate')) {
                        console.warn('‚ö†Ô∏è GitHub Pages SSL Certificate Issue Detected');
                        console.warn('‚ö†Ô∏è This should not happen with GitHub Pages - check network connection');
                        console.warn('‚ö†Ô∏è Use browser Developer Tools Network tab "Offline" mode for testing');
                        
                        // Show user-friendly message
                        const warningDiv = document.createElement('div');
                        warningDiv.style.cssText = `
                            position: fixed; top: 10px; right: 10px; z-index: 10000;
                            background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px;
                            padding: 12px; font-family: 'Segoe UI', sans-serif; font-size: 12px;
                            max-width: 300px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                        `;
                        warningDiv.innerHTML = `
                            <strong>‚ö†Ô∏è Offline Mode Setup Needed</strong><br>
                            Visit <a href="/sw.js" target="_blank" style="color: #0078d4;">localhost:3000/sw.js</a> 
                            and accept the SSL certificate for offline functionality.
                        `;
                        document.body.appendChild(warningDiv);
                        
                        // Auto-remove after 10 seconds
                        setTimeout(() => warningDiv.remove(), 10000);
                    }
                    
                    return null;
                });
            }
            
            // Try registration with fallback
            registerServiceWorker().then((registration) => {
                if (registration) {
                    console.log('üéâ Service Worker successfully registered for offline support');
                } else {
                    console.log('‚ö†Ô∏è Service Worker failed - using browser cache fallback');
                    implementBrowserCacheFallback();
                }
            });

            // Listen for service worker controller changes
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                console.log('üîÑ Service Worker controller changed - add-in now cached for offline use');
            });
        } else {
            console.warn('‚ö†Ô∏è Service Worker not supported in this environment');
        }

        // Network status monitoring
        window.addEventListener('online', () => { 
            console.log('üü¢ Network: ONLINE'); 
        });
        window.addEventListener('offline', () => { 
            console.log('üî¥ Network: OFFLINE - Add-in should work from cache'); 
        });

        // Office.js availability check
        function checkOfficeJs() {
            if (typeof Office !== 'undefined') {
                console.log('‚úÖ Office.js is available');
                console.log('üìä Office Host:', Office.context?.host?.name || 'Unknown');
                console.log('üìä Office Platform:', Office.context?.platform || 'Unknown');
                return true;
            } else {
                console.log('‚è≥ Waiting for Office.js...');
                return false;
            }
        }

        // Initial check
        checkOfficeJs();
        
        // Periodic check for Office.js (with timeout)
        const officeInterval = setInterval(() => {
            if (checkOfficeJs()) {
                clearInterval(officeInterval);
            }
        }, 500);

        // Stop checking after 10 seconds
        setTimeout(() => {
            clearInterval(officeInterval);
            if (typeof Office === 'undefined') {
                console.error('‚ùå Office.js failed to load after 10 seconds');
            }
        }, 10000);
    </script>
</body>

</html>
